---
title: "OnCustomDocumentMergerEx event"
description: Describe the OnCustomDocumentMergerEx Event in Business Central.
ms.custom: na
ms.date: 12/20/2023
ms.reviewer: solsen
ms.topic: conceptual
author: jswymer
---

# OnCustomDocumentMergerEx event

This article describes the syntax of the OnCustomDocumentMergerEx event, which will enable use of custom renders given a dataset and a layout. The layout must be specified as a Custom Layout in the rendering section within the report definition.

## Usage

Use the OnCustomDocumentMergerEx event to specify what happens when the user has specified a custom report layout type that is to be rendered into an artifact in application code. For more information about subscribing to this event, see [Developing Report Custom Render Extensions Overview](devenv-report-custom-render.md).

## Publisher

Codeunit **44 ReportManagement**.

## Raised

When a user runs a report that uses a custom layout format handled by application code (extension).

## Syntax

```AL
 [IntegrationEvent(false, false)]
local procedure OnCustomDocumentMergerEx(ObjectID: Integer; ReportAction: Option SaveAsPdf,SaveAsWord,SaveAsExcel,Preview,Print,SaveAsHtml; ObjectPayload: JsonObject; XmlData: InStream; LayoutData: InStream; var DocumentStream: OutStream; var IsHandled: Boolean)
```

## Parameters

### *ObjectID*

Type: [Integer](methods-auto/integer/integer-data-type.md)

The ID of the report object to be run.

### *ReportAction*

Type: [Option]

Specifies the action to take in the custom document merge process.

Valid values include:

- `SaveAsPdf` Generates a PDF document in the target stream.
- `SaveAsWord` Generates a Microsoft Word document in the target stream.
- `SaveAsExcel` Generates a Microsoft Excel document in the target stream.
- `SaveAsHtml` Generates an HTML document in the target stream.
- `Preview` Generates a PDF document in the target stream, which the platform downloads to the client for preview.
- `Print` Generates a PDF document in the target stream, which the platform prints using the printer specified for the present report ID.

### *ObjectPayload*

Type: [JsonObject](methods-auto/jsonobject/jsonobject-data-type.md)

Instance of the report payload. For more information, see [Report payload structure](#reportpayload).

### *XmlData*

Type: [InStream](methods-auto/instream/instream-data-type.md)

A stream object that contains the XML dataset generated by the platform runtime. This stream contains the input data for the rendering process.

### *LayoutData*

Type: [InStream](methods-auto/instream/instream-data-type.md)

A stream object that contains the report layout to be used in the rendering process. The platform provides this data from the standard report layout selection logic and it contains the currently selected layout.

### *Success*

Type: [Boolean](methods-auto/boolean/boolean-data-type.md)

Specifies whether the extension handled the merge action successfully.

> [!NOTE]  
> The platform will handle further processing of the result stream and the extension code must return the rendered artifact in the target stream. The platform will handle:
>
> - Saving to a specified file in save-as scenarios
> - Saving to a given stream
> - Download to the client
> - Print or preview

[!INCLUDE[report_payload_md](includes/report_payload.md)]

## Sample code

The simplest possible custom document render can be implemented as shown in the following sample, which will use the existing application logic to render XML datasets into Microsoft Word or PDF documents using a given template (Word template).

```al
    [EventSubscriber(ObjectType::Codeunit, Codeunit::ReportManagement, 'OnCustomDocumentMergerEx', '', true, true)]
    local procedure OnCustomDocumentMergerEx(ObjectID: Integer; ReportAction: Option SaveAsPdf,SaveAsWord,SaveAsExcel,Preview,Print,SaveAsHtml; ObjectPayload: JsonObject; XmlData: InStream; LayoutData: InStream; var DocumentStream: OutStream; var IsHandled: Boolean)
    var
        DocumentReportMgt: Codeunit "Document Report Mgt.";
        TempBlob: Codeunit "Temp Blob";
        DataInStream: InStream;
        DataOutStream: OutStream;
        SharedXmlData: InStream;
        SharedLayoutData: InStream;
        ObjectName: JsonToken;
        DocumentTypeParts: List of [Text];
        DocumentType: JsonToken;
        Extension: Text;
        Token: JsonToken;
        MimeType: Text;
        LayoutName: Text;
        LayoutModel: Text;
        JsonText: Text;
        JsonFile: File;
    begin        
        if IsHandled then
            exit;

        // Setup shared streams

        // Empty stream, no actions possible on the stream so return immediately
        if XmlData.Length < 1 then
            exit;

        // Use a shared stream and reset the read pointer to beginning of stream
        SharedXmlData := XmlData;
        if SharedXmlData.Position > 1 then
            SharedXmlData.ResetPosition();

        SharedLayoutData := LayoutData;
        if SharedLayoutData.Position > 1 then
            SharedLayoutData.ResetPosition();

        Init();

        // Sample code to persist the JSON object to disk
        ObjectPayload.WriteTo(JsonText);
        JsonFile.TextMode := true;
        JsonFile.Create(TempFolderPath + 'OnCustomDocumentMergerEx.json', TextEncoding::UTF8);
        JsonFile.Write(JsonText);
        JsonFile.Close();

        // Get report options from the JSON object
        ObjectPayload.Get('objectname', ObjectName);
        ObjectPayload.Get('documenttype', DocumentType);
        ObjectPayload.Get('layoutmimetype', Token);
        MimeType := Token.AsValue().AsText();

        ObjectPayload.Get('layoutname', Token);
        LayoutName := Token.AsValue().AsText();

        ObjectPayload.Get('layoutmodel', Token);
        LayoutModel := Token.AsValue().AsText();

        DocumentTypeParts := DocumentType.AsValue().AsText().Split('/');
        
        // Notice that the Extension string below have to be remapped to a standard file extension
        // based on the document mimetype
        Extension := DocumentTypeParts.Get(DocumentTypeParts.Count);

        TempBlob.CreateOutStream(DataOutStream);

        // The 
        case ReportAction of
            ReportAction::SaveAsPdf, ReportAction::Preview, ReportAction::Print:
                begin
                    if not DocumentReportMgt.TryXmlMergeWordDocument(SharedLayoutData, SharedXmlData, DataOutStream) then
                        error('Unable to handle custom document merge');
                    DocumentReportMgt.ConvertWordToPdf(TempBlob, ObjectID);
                    TempBlob.CreateInStream(DataInStream);
                    CopyStream(DocumentStream, DataInStream);
                    IsHandled := true;
                end;
            ReportAction::SaveAsHtml:
                begin
                    if not DocumentReportMgt.TryXmlMergeWordDocument(SharedLayoutData, SharedXmlData, DataOutStream) then
                        error('Unable to handle custom document merge');
                    DocumentReportMgt.ConvertWordToHtml(TempBlob);
                    TempBlob.CreateInStream(DataInStream);
                    CopyStream(DocumentStream, DataInStream);
                    IsHandled := true;
                end;
            ReportAction::SaveAsWord:
                begin
                    if not DocumentReportMgt.TryXmlMergeWordDocument(SharedLayoutData, SharedXmlData, DocumentStream) then
                        error('Unable to handle custom document merge');
                    IsHandled := true;
                end;
            else
                error('Unsupported report action %0', ReportAction);
        end;
    end;
```

## See also

[Working With and Troubleshooting Payloads](devenv-reports-troubleshoot-printing.md)  
[Developing Report Custom Render Extensions Overview](devenv-report-custom-render.md)  
[Developing Printer Extensions Overview](devenv-reports-printing.md)  
[Creating a Printer Extension](devenv-reports-create-printer-extension.md)  
[Events in AL](devenv-events-in-al.md)  
[Publishing Events](devenv-publishing-events.md)  
[Raising Events](devenv-raising-events.md)  
[Subscribing to Events](devenv-subscribing-to-events.md)  
